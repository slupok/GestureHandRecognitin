#ifndef GESTURERECOGNITION_H
#define GESTURERECOGNITION_H
#include <math.h>
#include <QFile>

#include "imageDataBuffer.h"
#include "ImageProcessing/imageProcessing.h"
#include "../Camera/camera.h"
#include "../Camera/webcam.h"

#include "ImageProcessing/OpenCL/opencl_context.h"

#define GESTURE_COUNT 4
#define INVARIANTS_COUNT 7
#define MOMENTS_COUNT 5//колво моментов на жест

#define FIVE_INV 0
#define NICE_INV 1


#if 0
{//FIVE
/*I1*/            {-0.0163198,  -0.0467075,  -0.00430528, -0.0370719,  -0.0314907,  -0.0322954,  0.0494284   },
/*I2*/            {0.00994128,  0.000121478, 0.00245868,  0.000158995, 9.09273e-05, 0.000127182, 9.38002e-05   },
/*I3*/            {0.00994128,  0.00436319,  0.00566994,  0.00274865,  0.00198333,  0.00208599,  0.00698791   },
/*I4*/            {0.00994128,  0.00436319,  0.00566994,  0.00274865,  0.00198333,  0.00208599,  0.00698791   },
/*I5*/            {9.88291e-05, 1.90374e-05, 3.21482e-05, 7.55507e-06, 3.9336e-06,  4.35134e-06, 4.88309e-05  },
/*I6*/            {0.000140394, 4.80898e-05, 4.52326e-05, 3.46586e-05, 1.89122e-05, 2.35247e-05, 6.61121e-05  },
/*I7*/            {6.08529e-05, 1.90374e-05, 1.73738e-05, 7.55507e-06, 3.9336e-06,  4.35134e-06, 2.59871e-05  }
},


{//NICE
/*I1*/            {0.0895471f,  0.0928822f,  0.0909935f,  0.116136f,   -0.00704134,   0.108428f, 0.0802322},
/*I2*/            {0.00222431f, 0.00215048f, 0.00231714f, 0.0035011f,  0.00915028, 0.0031716f, 0.00208849},
/*I3*/            {0.122154f,   0.148594f,   0.124779f,   0.0722959f,  0.0176152,  0.0584049f, 0.032447},
/*I4*/            {0.122153f,   0.148594f,   0.124779f,   0.0722959f,  0.0176152,  0.0584049f, 0.032447},
/*I5*/            {0.0149215f,  0.0220802f,  0.0155698f,  0.0052267f,  0.000310295, 0.00341113f, 0.00105281},
/*I6*/            {0.00574807f, 0.00689062f, 0.00596922f, 0.00375879f, 0.000707848, 0.00300428f, 0.000951403},
/*I7*/            {0.00979165f, 0.0146727f,  0.010176f,   0.003316f,   0.000166788, 0.00213167f, 0.000696249}
},

{//THREE
/*I1*/            { 0.0670857,     0.0535087,   0.0586106,    -0.0188658,    -0.030689,   -0.0279843,   -0.0410548 },
/*I2*/            { 0.00181537,    0.00105755,  0.001272,     0.00305154,    0.00370221,  0.00571,      0.000162549 },
/*I3*/            { 0.0282371,     0.035477,    0.0364773,    0.00922876,    0.0160128,   0.0193655,    0.003371 },
/*I4*/            { 0.0282371,     0.035477,    0.0364773,    0.00922876,    0.0160128,   0.0193655,    0.003371 },
/*I5*/            { 0.000797334,   0.00125862,  0.00133059,   8.517e-05,     0.00025641,  0.000375024,  1.13636e-05 },
/*I6*/            { 0.000863226,   0.000666402, 0.000766968,  0.000234258,   0.000251157, 0.000530868,  4.29785e-05 },
/*I7*/            { 0.000535247,   0.000879418, 0.000924538,  5.4412e-05,    0.000172176, 0.000240839,  1.13636e-05 }
#endif
class GestureRecognition : public QObject
{
    Q_OBJECT
public:
    GestureRecognition();
    ~GestureRecognition();
    static void thresholdColorConversion(ImageBuffer *buffer);
    void startGR();
    void setUI(WebCam *ui);

public slots:
    void onUpdateFrame(QImage frame);

private:
    float NormalizedCentralMoment(int p, int q, int cx, int cy, int m00);

private:
    WebCam *m_ui;
    Camera *m_camera;
    IPContext *m_context;

    bool m_block;
    int cntFrame = 0;//костыль
    IPImage *m_image;
    IPImage *m_backgroundMask;
    IPImage *m_mask;
    IPImage *m_tmpMask;

    //[количество жестов] [инварианты(I1 - I7)] [кол-во моментов]
    float m_DataInv[GESTURE_COUNT][INVARIANTS_COUNT][MOMENTS_COUNT] = {

        {//FIVE
/*I1*/            {0.0615554,    0.0603889,    0.0511095,    0.0534412,    0.0507631  },
/*I2*/            {0.000106103,  0.000101047,  8.80011e-05,  8.68162e-05,  7.29581e-05},
/*I3*/            {0.0397348,    0.0394448,    0.0200887,    0.0227824,    0.0188558  },
/*I4*/            {0.0397348,    0.0394447,    0.0200887,    0.0227824,    0.0188558  },
/*I5*/            {0.00157885,   0.00155589,   0.000403554,  0.000519039,  0.000355539},
/*I6*/            {0.000405856,  0.000388815,  0.000141205,  0.000168483,  0.00013763 },
/*I7*/            {0.00101549,   0.00100511,   0.000257469,  0.000331198,  0.000224246} },


        {//NICE
/*I1*/            {0.0739533,  0.0753686 ,  0.0779389,  0.0904668,   0.0904668 },
/*I2*/            {0.00106087, 0.00110573,  0.00123795, 0.0019031,   0.00188523},
/*I3*/            {0.320625,   0.362642,    0.401574,   0.185462,    0.174823  },
/*I4*/            {0.320625,   0.362642,    0.401574,   0.185462,    0.174823  },
/*I5*/            { 0.1028,    0.13151,     0.161262,   0.0343961,   0.030563  },
/*I6*/            {0.009544,   0.0109316,   0.0128851,  0.00645205,  0.00598996},
/*I7*/            {0.0732019,  0.0938967,   0.115233,   0.0239323,   0.0212735 } },

        {//THREE
/*I1*/            { 0.0732608,     0.0712561,    0.0691404,    0.0696871,     0.0688371  },
/*I2*/            { 0.000604777,   0.000549942,  0.000506437,  0.000480408,   0.000421161},
/*I3*/            { 0.0423553,     0.040507,     0.0378789,    0.0374632,     0.0340527  },
/*I4*/            { 0.0423553,     0.040507,     0.0378789,    0.0374632,     0.0340527  },
/*I5*/            { 0.00179397,    0.00164082,   0.00143481,   0.00140349,    0.00115959 },
/*I6*/            { 0.000521337,   0.000488936,  0.000431634,  0.000388656,   0.000351985},
/*I7*/            { 0.00118531,    0.00108318,   0.000946475,  0.000923461,   0.000756144} },

        {//ROCK
/*I1*/            { 0.0920754,  0.1027,     -0.0407256,   0.0942083,   0.0942083 },
/*I2*/            { 0.0011308,  0.00292099,  0.00995682,  0.00262867,  0.00262867},
/*I3*/            { 0.156403,   0.10073,     0.0378789,   0.0643037,   0.0643037 },
/*I4*/            { 0.156403,   0.10073,     0.0378789,   0.0643037,   0.0643037 },
/*I5*/            { 0.0244618,  0.0101465,   0.00143481,  0.00413497,  0.00413497},
/*I6*/            { 0.00179983, 0.00151208,  0.000902898, 0.00107332,  0.00107332},
/*I7*/            { 0.0170237,  0.00703593,  0.000929703, 0.00283758,  0.00283758} }

    };

    float m_fiveInv[7];
    float m_niceInv[7];

};
#endif // GESTURERECOGNITION_H
